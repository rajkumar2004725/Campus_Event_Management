<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student App - Campus Events</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 10px; background-color: #f4f4f4; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        form { margin-bottom: 15px; }
        input, button { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #28a745; color: white; cursor: pointer; }
        button:hover { background: #218838; }
        .event-list { margin-top: 15px; }
        .event-item { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .register-btn { background: #007bff; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; width: auto; }
        @media (min-width: 601px) { .container { max-width: 600px; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Student App</h1>
        
        <!-- Browse Events -->
        <div class="event-list">
            <h2>Browse Events</h2>
            <button onclick="loadEvents()">Load Events</button>
            <div id="eventsContainer"></div>
        </div>

        <!-- Register Form -->
        <form id="registerForm">
            <h2>Register</h2>
            <input type="number" id="studentId" placeholder="Your Student ID" required>
            <input type="number" id="eventId" placeholder="Event ID" required>
            <button type="submit">Register</button>
        </form>

        <!-- Check-in & Feedback -->
        <form id="checkinForm">
            <h2>Check-in / Feedback</h2>
            <input type="number" id="regId" placeholder="Registration ID" required>
            <button type="button" onclick="markAttendance()">Mark Attended</button>
            <input type="number" id="feedbackRating" placeholder="Rating (1-5)" min="1" max="5">
            <button type="button" onclick="submitFeedback()">Submit Feedback</button>
        </form>

        <!-- Participation Report -->
        <div>
            <h2>My Participation</h2>
            <input type="number" id="myStudentId" placeholder="Your Student ID">
            <button onclick="getParticipation()">View</button>
            <div id="participationReport"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';

        // Load Events
        async function loadEvents() {
            try {
                const response = await fetch(`${API_BASE}/events`);
                const events = await response.json();
                const container = document.getElementById('eventsContainer');
                container.innerHTML = events.map(event => `
                    <div class="event-item">
                        ${event.name} (${event.type}) - ${new Date(event.date).toLocaleDateString()} | ${event.cancelled ? 'Cancelled' : 'Active'}
                        <button class="register-btn" onclick="registerForEvent(${event.id})">Register</button>
                    </div>
                `).join('');
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Register
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = parseInt(document.getElementById('studentId').value);
            const eventId = parseInt(document.getElementById('eventId').value);
            try {
                const response = await fetch(`${API_BASE}/registrations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: studentId, event_id: eventId })
                });
                if (response.ok) {
                    alert('Registered!');
                    document.getElementById('registerForm').reset();
                } else if (response.status === 409) {
                    alert('Already registered!');
                } else {
                    alert('Error: ' + (await response.text()));
                }
            } catch (err) {
                alert('Network error: ' + err.message);
            }
        });

        function registerForEvent(eventId) {
            const studentId = prompt('Enter your Student ID:');
            if (studentId) {
                document.getElementById('studentId').value = studentId;
                document.getElementById('eventId').value = eventId;
                document.getElementById('registerForm').dispatchEvent(new Event('submit'));
            }
        }

        // Mark Attendance
        async function markAttendance() {
            const regId = parseInt(document.getElementById('regId').value);
            try {
                const response = await fetch(`${API_BASE}/registrations/${regId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ attended: true })
                });
                if (response.ok) {
                    alert('Attendance marked!');
                } else {
                    alert('Error: ' + (await response.text()));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Submit Feedback
        async function submitFeedback() {
            const regId = parseInt(document.getElementById('regId').value);
            const rating = parseInt(document.getElementById('feedbackRating').value);
            if (!rating || rating < 1 || rating > 5) {
                alert('Rating must be 1-5');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/registrations/${regId}/feedback`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating })
                });
                if (response.ok) {
                    alert('Feedback submitted!');
                    document.getElementById('feedbackRating').value = '';
                } else {
                    alert('Error: ' + (await response.text()));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Participation Report
        async function getParticipation() {
            const studentId = parseInt(document.getElementById('myStudentId').value);
            try {
                const response = await fetch(`${API_BASE}/reports/student-participation/${studentId}`);
                const data = await response.json();
                document.getElementById('participationReport').innerHTML = `<p>Attended ${data.attended_events} events.</p>`;
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }
    </script>
</body>
</html>
